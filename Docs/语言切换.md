# OpenChat 语言切换实现说明

## 技术方案

基于 **WPF ResourceDictionary 动态替换**机制，实现运行时无需重启的多语言切换。

## 支持语言

10种语言：英语(en)、简体中文(zh-hans)、繁体中文(zh-hant)、日语(ja)、阿拉伯语(ar)、西班牙语(es)、法语(fr)、俄语(ru)、乌尔都语(ur)、土耳其语(tr)

---

## 核心组件

### 1. LanguageService

**职责**：语言资源管理和动态切换

**关键成员**：
- `languageResources`：CultureInfo 到 ResourceDictionary 的映射字典
- `CurrentLanguage`：当前语言属性（支持读写）
- `SetLanguage(CultureInfo)`：语言切换核心方法

**切换逻辑**：
```csharp
public bool SetLanguage(CultureInfo language)
{
    // 1. 智能匹配：精确匹配 → ISO代码匹配
    CultureInfo? key = Languages.FirstOrDefault(k => k.Equals(language))
                    ?? Languages.FirstOrDefault(k => k.TwoLetterISOLanguageName == language.TwoLetterISOLanguageName);

    if (key != null)
    {
        // 2. 移除旧语言资源（通过 IsLanguageResource 标记识别）
        var oldResources = Application.Current.Resources.MergedDictionaries
            .Where(dict => dict.Contains("IsLanguageResource")).ToList();
        oldResources.ForEach(r => Application.Current.Resources.MergedDictionaries.Remove(r));

        // 3. 添加新语言资源
        Application.Current.Resources.MergedDictionaries.Add(languageResources[key]);
        currentLanguage = key;
        return true;
    }
    return false;
}
```

### 2. 语言资源文件

**目录结构**：`OpenChat/Themes/Languages/`

**文件组成**：
- `_base.xaml`：基础英文资源（默认语言）
- `{language}.xaml`：各语言翻译资源

**资源格式**：
```xml
<ResourceDictionary>
    <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="_base.xaml"/>  <!-- 继承基础资源 -->
    </ResourceDictionary.MergedDictionaries>

    <!-- 覆盖特定语言字符串 -->
    <s:String x:Key="StrConfiguration">配置</s:String>
    <s:String x:Key="StrLanguage">语言</s:String>
    <!-- 资源标记（用于动态移除） -->
    <s:Boolean x:Key="IsLanguageResource">True</s:Boolean>
</ResourceDictionary>
```

### 3. 配置持久化

**存储**：`AppConfig.Language` 属性（字符串类型，如 `"zh-hans"`）

**初始化**：
```csharp
public void Init()
{
    // 优先级：配置文件 > 系统语言
    CultureInfo language = CultureInfo.CurrentCulture;
    if (!string.IsNullOrWhiteSpace(ConfigurationService.Configuration.Language))
        language = new CultureInfo(ConfigurationService.Configuration.Language);

    SetLanguage(language);
}
```

**保存**：
```csharp
ConfigurationService.Configuration.Language = LanguageService.CurrentLanguage.ToString();
ConfigurationService.Save();
```

### 4. UI 层绑定

**选择器**：
```xml
<ListBox ItemsSource="{Binding LanguageService.Languages}"
         SelectedItem="{Binding LanguageService.CurrentLanguage}">
    <ListBox.ItemTemplate>
        <DataTemplate>
            <TextBlock Text="{Binding NativeName, Mode=OneWay}" />
        </DataTemplate>
    </ListBox.ItemTemplate>
</ListBox>
```

**文本引用**：
```xml
<!-- 使用 DynamicResource 实现自动刷新 -->
<TextBlock Text="{DynamicResource StrConfiguration}" />
<Run Text="{DynamicResource StrLanguage}" />
```

---

## 完整流程

```
应用启动
  ↓
LanguageService.Init()
  ↓
读取配置文件 → 确定初始语言 → SetLanguage()
  ↓
用户在 ConfigPage 选择语言
  ↓
LanguageService.CurrentLanguage = 新语言
  ↓
SetLanguage() 执行：
  1. 移除旧语言 ResourceDictionary
  2. 添加新语言 ResourceDictionary
  ↓
所有 DynamicResource 自动刷新显示
  ↓
点击保存按钮 → 写入配置文件 → 下次启动生效
```

---

## 关键设计

### 1. 智能匹配策略
- **精确匹配**：优先匹配完整 CultureInfo（如 `zh-hans`）
- **降级匹配**：按 ISO 双字母代码匹配（如 `zh` 匹配任意中文变体）
- **容错性**：匹配失败不崩溃，返回 `false`

### 2. 资源标记机制
通过 `IsLanguageResource=True` 标记，精准识别并移除语言资源，避免误删其他 MergedDictionaries

### 3. 翻译回退
各语言文件通过 `MergedDictionaries` 引用 `_base.xaml`，未翻译的键自动回退到英文

### 4. 零重启切换
利用 WPF 的 `DynamicResource` 机制，资源字典变更时自动触发 UI 更新

---

## 添加新语言步骤

1. 在 `Themes/Languages/` 创建 `{language-code}.xaml`
2. 继承 `_base.xaml` 并翻译字符串键
3. 在 `LanguageService.languageResources` 添加映射：
   ```csharp
   { new CultureInfo("ko"), new ResourceDictionary()
       { Source = new Uri($"{resourceUriPrefix}/Themes/Languages/ko.xaml") } }
   ```
4. 确保文件编码为 **UTF-8 with BOM**

---

## 技术亮点

✅ **实时生效**：无需重启应用
✅ **资源复用**：翻译继承机制减少冗余
✅ **智能匹配**：多级匹配策略提高兼容性
✅ **解耦设计**：UI 通过 DynamicResource 自动响应变化
✅ **持久化**：用户选择自动保存并在下次启动恢复
